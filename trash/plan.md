# Скибиди

---

### **План решения задачи**

#### **1. Анализ задачи и данных**

- [ ] Изучить описание теста TPC-H по предоставленной ссылке.
- [ ] Проанализировать структуру таблиц и их взаимосвязи.
- [ ] Определить цели:
  - [ ] Ускорить выполнение запросов минимум на 20% (или 50% для более высоких баллов).
  - [ ] Найти способ выполнения "запросов со звёздочкой" (Q9, Q10, Q22), которые сейчас не работают из-за ограничений памяти.
- [ ] Оценить текущие результаты выполнения запросов.

#### **2. Подготовка тестовой среды**

- [ ] Создать подмножество данных с использованием встроенного генератора данных Trino (Scale Factor sf1 или sf10).
- [ ] Выполнить команду `USE data.hackaton;` для работы с подготовленными данными.
- [ ] Протестировать производительность оригинальных запросов на тестовых данных.

#### **3. Эксперименты с партиционированием**

- [ ] Проанализировать текущее разбиение файлов в формате Parquet (~1 ГБ на файл).
- [ ] Предложить новое партиционирование:
  - [ ] Разделить данные по часто используемым фильтрам (например, `shipdate`, `region`, `nation`).
  - [ ] Пример: создать партиции по году (`shipdate`) для таблицы `lineitem`.
- [ ] Реализовать новое разбиение:
  - [ ] Создать новые таблицы с использованием команды `CREATE TABLE ... WITH (partitioned_by = ARRAY['column'])`.
  - [ ] Заполнить таблицы данными с помощью `INSERT INTO ... SELECT * FROM tpch.sf10.<table>`.

#### **4. Оптимизация SQL-запросов**

- [ ] Для каждого запроса:
  - [ ] Использовать `EXPLAIN` для анализа плана выполнения.
  - [ ] Оптимизировать запрос:
    - [ ] Добавить фильтры на ранних этапах.
    - [ ] Изменить порядок JOIN.
    - [ ] Использовать индексы для часто фильтруемых столбцов.
    - [ ] Перенести часть вычислений в подзапросы.
  - [ ] Протестировать изменения на тестовых данных.

#### **5. Решение "задач со звёздочкой"**

- **Q9**:
  - [ ] Разделить запрос на несколько частей.
  - [ ] Использовать партиционирование по `nationkey` и `orderdate`.
- **Q10**:
  - [ ] Уменьшить объем данных перед агрегацией:
    - [ ] Фильтровать данные по `orderdate` и `returnflag`.
    - [ ] Разделить таблицу `lineitem` по `shipdate` или `orderkey`.
- **Q22**:
  - [ ] Предварительно вычислить среднее значение `acctbal` для каждой страны.
  - [ ] Использовать партиционирование по первым 2 символам `phone`.

#### **6. Подготовка результатов**

- [ ] Создать скрипты для каждого запроса:
  - [ ] `<team>-Qxx-prepare.sql`: скрипт создания таблиц и загрузки данных (если требуется новое разбиение).
  - [ ] `<team>-Qxx-run.sql`: оптимизированный запрос.
- [ ] Проверить корректность результатов:
  - [ ] Убедиться, что результаты совпадают с оригинальными.
  - [ ] Зафиксировать время выполнения для каждого запроса.
- [ ] Подсчитать баллы:
  - [ ] Сравнить улучшение времени выполнения с исходными значениями.
  - [ ] Учесть штрафы за создание лишних таблиц.

#### **7. Документация и сдача**

- [ ] Описать решения:
  - [ ] Кратко объяснить изменения для каждого запроса.
  - [ ] Обосновать выбор партиционирования или переписывания запроса.
- [ ] Сдать результаты:
  - [ ] Отправить все скрипты в указанном формате.
  - [ ] Приложить отчет с временами выполнения и расчетом баллов.

---

Этот план теперь представлен в формате Markdown с использованием `[ ]` для удобного отслеживания выполнения задач.
